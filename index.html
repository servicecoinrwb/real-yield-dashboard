<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Coin Real-Yield Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.1/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #eventLog::-webkit-scrollbar { width: 8px; }
        #eventLog::-webkit-scrollbar-track { background: #1a202c; } /* Even darker gray */
        #eventLog::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        #eventLog::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-orange-400">Service Coin Real-Yield Dashboard</h1>
        </header>

        <div id="walletStatus" class="mb-6 text-center">
            <button onclick="connectWallet()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105">
                Connect Wallet
            </button>
        </div>

        <div id="solverSection" class="hidden text-left space-y-6 mb-6">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border-2 border-yellow-500">
                    <h2 class="text-xl font-semibold text-yellow-300 mb-3 border-b border-gray-700 pb-2">Your Solver Loan Status</h2>
                    <div id="solverLoanInfo" class="space-y-2 text-md">
                        <p>Outstanding Loan Principal: <span id="solverLoanPrincipal" class="font-bold text-cyan-400">...</span></p>
                        <p>Accrued Interest: <span id="solverLoanInterest" class="font-bold text-red-400">...</span></p>
                        <hr class="border-gray-700 my-3">
                        <p class="text-lg">Total Amount Due: <span id="solverTotalDue" class="font-bold text-yellow-400">...</span></p>
                    </div>
                     <p class="text-xs text-gray-400 mt-3">This section is visible because you are a whitelisted solver.</p>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border-2 border-yellow-500 space-y-4">
                     <h2 class="text-xl font-semibold text-yellow-300 mb-3 border-b border-gray-700 pb-2">Solver Actions</h2>
                     <div>
                        <label class="block mb-1 text-sm font-semibold">Repay Loan Principal to Kernel (USDC):</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="repayAmount" type="number" placeholder="USDC Principal Amount" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                            <button onclick="approveRepayLoan()" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-md font-semibold">Approve</button>
                            <button onclick="repayLoan()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-md font-semibold">Repay</button>
                        </div>
                         <p class="text-xs text-gray-400 mt-1">Repay the principal loan amount.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-semibold">Pay Profit/Fees on Loan to Kernel (USDC):</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="feeAmount" type="number" placeholder="USDC Fee Amount" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                            <button onclick="approveProcessFees()" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-md font-semibold">Approve</button>
                            <button onclick="processFees()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-md font-semibold">Pay</button>
                        </div>
                         <p class="text-xs text-gray-400 mt-1">Send the profit/interest portion of a repayment.</p>
                    </div>
                </div>
             </div>
        </div>

        <div id="userSection" class="hidden text-left space-y-6">
            <!-- User Wallet & Actions Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold text-orange-300 mb-3 border-b border-gray-700 pb-2">Your Wallet</h2>
                    <div id="userInfo" class="space-y-2 text-md">
                        <p>Address: <span id="walletAddress" class="font-mono text-sm bg-gray-700 p-1 rounded break-all"></span></p>
                        <p>USDC Balance: <span id="nativeUsdcBalance" class="font-bold text-cyan-400">...</span></p>
                        <hr class="border-gray-700 my-3">
                        <p>Your Shares (Investor Vault): <span id="userShares" class="font-bold text-green-400">...</span></p>
                        <p>Claimable Yield (Investor Vault): <span id="claimableYield" class="font-bold text-green-400">...</span></p>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold text-orange-300 mb-3 border-b border-gray-700 pb-2">Your Actions</h2>
                    <div class="mb-4">
                        <label class="block mb-1 text-sm font-semibold">Deposit USDC to Investor Vault:</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="depositAmount" type="number" placeholder="USDC Amount" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600 focus:ring-orange-500 focus:border-orange-500" />
                            <button onclick="approveDeposit()" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-md font-semibold whitespace-nowrap">Approve</button>
                            <button onclick="deposit()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-md font-semibold">Deposit</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">First approve, then deposit.</p>
                    </div>
                    <div class="flex flex-wrap justify-around gap-3 mt-3">
                        <button onclick="claimYield()" class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded-md font-semibold flex-grow">Claim Yield</button>
                        <button onclick="compoundYield()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-md font-semibold text-black flex-grow">Compound Yield</button>
                        <button onclick="withdraw()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md font-semibold flex-grow">Withdraw All</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="daoTools" class="hidden mt-8 border-t-2 border-orange-400 pt-6 text-left space-y-6">
            <h2 class="text-2xl font-semibold text-orange-300 mb-4 text-center">DAO & Solver Tools</h2>

            <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-orange-300 mb-3 border-b border-gray-700 pb-2">System Stats</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-md">
                    <p>Kernel Balance (Live): <span id="kernelBalance" class="font-bold text-yellow-300">...</span></p>
                    <p>Investor Vault Balance (Live): <span id="investorVaultBalance" class="font-bold text-blue-300">...</span></p>
                    <p>Yield Vault Balance (Live): <span id="yieldVaultBalance" class="font-bold text-purple-300">...</span></p>
                    <p>Total Capital Deployed (Kernel): <span id="totalCapitalDeployed" class="font-bold text-yellow-300">...</span></p>
                    <p>Total Deposits (Investor Vault): <span id="investorVaultTotalDeposits" class="font-bold text-blue-300">...</span></p>
                    <p>Total Fees Processed (Kernel): <span id="totalFeesProcessed" class="font-bold text-purple-300">...</span></p>
                    <p>Current Performance Fee: <span id="performanceFee" class="font-bold text-pink-400">...</span></p>
                </div>
            </div>

            <!-- Management Grids -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Capital & Fee Management -->
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-orange-300 mb-2 border-b border-gray-700 pb-2">Capital & Fee Management</h3>
                    <div>
                        <label class="block mb-1 text-sm font-semibold">Fund Kernel from Wallet (USDC):</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="kernelAmount" type="number" placeholder="USDC Amount" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                            <button onclick="approveFundKernel()" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-md font-semibold">Approve</button>
                            <button onclick="fundKernel()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md font-semibold">Fund</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Adds capital from your wallet directly to the Kernel.</p>
                    </div>
                     <div>
                        <label class="block mb-1 text-sm font-semibold">Set DAO Performance Fee:</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="performanceFeeBps" type="number" placeholder="Fee in BPS (e.g., 2000 for 20%)" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600"/>
                            <button onclick="setPerformanceFee()" class="bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-md font-semibold">Set Fee</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Sets the DAO's take rate on profits.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-semibold">Sweep Fees from Yield Vault to Treasury:</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                             <input id="sweepAmount" type="number" placeholder="USDC Amount (optional)" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                            <button onclick="sweepFees()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-md font-semibold">Sweep</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Leave amount blank to sweep the full balance.</p>
                    </div>
                </div>

                <!-- Solver & Loan Management -->
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-orange-300 mb-2 border-b border-gray-700 pb-2">Solver & Loan Management (Admin)</h3>
                     <div>
                        <label class="block mb-1 text-sm font-semibold">Manage Solver Whitelist:</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="solverAddress" type="text" placeholder="Solver Address" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                            <button onclick="addSolver()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-md font-semibold">Add</button>
                            <button onclick="removeSolver()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md font-semibold">Remove</button>
                            <button onclick="checkSolverStatus()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-md font-semibold">Check</button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-semibold">Disburse Loan to Solver (USDC):</label>
                        <div class="flex flex-col gap-2">
                             <input id="disburseSolverAddress" type="text" placeholder="Whitelisted Solver Address" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                             <input id="disburseAmount" type="number" placeholder="USDC Amount" class="bg-gray-700 text-white w-full p-2 rounded-md border border-gray-600" />
                             <button onclick="disburseLoan()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md font-semibold w-full">Disburse Loan</button>
                        </div>
                         <p class="text-xs text-gray-400 mt-1">Sends funds from the Kernel to a whitelisted solver.</p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                 <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                    <h3 class="text-xl font-semibold text-orange-300 mb-3 border-b border-gray-700 pb-2">Batch Operations (Investor Vault)</h3>
                    <textarea id="batchAddresses" placeholder="Enter investor addresses, one per line" class="w-full p-2 bg-gray-700 text-white rounded-md border border-gray-600 h-24"></textarea>
                    <div class="space-x-3 mt-2">
                      <button onclick="daoBatchClaim()" class="bg-green-800 hover:bg-green-900 px-4 py-2 rounded-md font-semibold">Batch Claim</button>
                      <button onclick="daoBatchWithdraw()" class="bg-red-800 hover:bg-red-900 px-4 py-2 rounded-md font-semibold">Batch Withdraw</button>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                    <h3 class="text-xl font-semibold text-orange-300 mb-2">ðŸ“œ Transaction Log</h3>
                    <ul id="eventLog" class="text-sm text-gray-300 space-y-1 h-48 overflow-y-auto bg-gray-900 p-2 rounded-md"></ul>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Global Scope Variables ---
    let provider, signer, usdcContract, investorVaultContract, yieldVaultContract, kernelContract;
    let currentAddress;
    let shareAmount = 0n;
    let isSolver = false; // Moved to global scope

    // --- Contract Addresses & ABIs (UPDATED) ---
    const addresses = {
        nativeUsdc: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831',
        investorVault: '0x1a51f1966d35661573908DC913307076d937aa90',
        yieldVault: '0x44D64E1B9dC5F90b389900Da24B8de631222432C',
        kernel: '0x44Bc37669d7cFA3c9Ea93CC0b1520a58FE59d7b3', // CORRECTED KERNEL ADDRESS
    };

    const abis = {
        usdc: JSON.parse(`[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]`),
        investorVault: JSON.parse(`[{"inputs":[{"internalType":"address","name":"_usdc","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesMinted","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesBurned","type":"uint256"}],"name":"Withdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"YieldClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newShares","type":"uint256"}],"name":"YieldCompounded","type":"event"},{"inputs":[],"name":"LOCKUP_PERIOD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchClaimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"claimableYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"compoundYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"depositTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fundKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"getInvestorInfo","outputs":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"uint256","name":"claimable","type":"uint256"},{"internalType":"uint256","name":"claimed","type":"uint256"},{"internalType":"uint256","name":"unlockTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultTotals","outputs":[{"internalType":"uint256","name":"totalUSDC","type":"uint256"},{"internalType":"uint256","name":"totalSharesMinted","type":"uint256"},{"internalType":"uint256","name":"totalYield","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernel","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"receiveYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_kernel","type":"address"}],"name":"setKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"shares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDeposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalYieldDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shareAmount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}]`),
        yieldVault: JSON.parse(`[{"inputs":[{"internalType":"address","name":"_governance","type":"address"},{"internalType":"address","name":"_kernel","type":"address"},{"internalType":"address","name":"_feeToken","type":"address"},{"internalType":"address","name":"_daoTreasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldTreasury","type":"address"},{"indexed":true,"internalType":"address","name":"newTreasury","type":"address"}],"name":"DaoTreasuryUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"fromKernel","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesDepositedInVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesSweptToTreasury","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[],"name":"daoTreasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernelAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"recordFeeDeposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newTreasury","type":"address"}],"name":"setDaoTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newKernel","type":"address"}],"name":"setKernelAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"sweepFullBalanceToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"sweepToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}]`),
        // CORRECTED KernelSmartAccountV2 ABI
        kernel: JSON.parse(`[{"inputs":[{"internalType":"address","name":"_governance","type":"address"},{"internalType":"address","name":"_initialSolver","type":"address"},{"internalType":"address","name":"_yieldVault","type":"address"},{"internalType":"address","name":"_investorVault","type":"address"},{"internalType":"address","name":"_token","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"funder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"CapitalDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"vault","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesForwardedToVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldVault","type":"address"},{"indexed":true,"internalType":"address","name":"newVault","type":"address"}],"name":"InvestorVaultAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"KernelFundsWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"solver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LoanDisbursed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"string","name":"note","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"LoanNoteLogged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"solver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LoanPrincipalRepaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeeBps","type":"uint256"}],"name":"PerformanceFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"solver","type":"address"},{"indexed":false,"internalType":"bool","name":"isWhitelisted","type":"bool"}],"name":"SolverAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"vault","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"YieldDistributedToInvestors","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldVault","type":"address"},{"indexed":true,"internalType":"address","name":"newVault","type":"address"}],"name":"YieldVaultAddressUpdated","type":"event"},{"inputs":[],"name":"capitalToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"depositCapital","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"solver","type":"address"},{"internalType":"uint256","name":"_loanAmount","type":"uint256"}],"name":"disburseLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getKernelBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_solver","type":"address"}],"name":"getLoanDetails","outputs":[{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"interest","type":"uint256"},{"internalType":"uint256","name":"lastAccrued","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"investorVaultAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"note","type":"string"}],"name":"logLoanNote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"performanceFeeBps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_feeAmountReceivedByKernel","type":"uint256"}],"name":"processSolverFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_repaidAmount","type":"uint256"}],"name":"recordLoanPrincipalRepayment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newInvestorVault","type":"address"}],"name":"setInvestorVaultAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFeeBps","type":"uint256"}],"name":"setPerformanceFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_solver","type":"address"},{"internalType":"bool","name":"_whitelisted","type":"bool"}],"name":"setSolverAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newYieldVault","type":"address"}],"name":"setYieldVaultAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalCapitalDeployed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalFeesProcessedViaKernel","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"whitelistedSolvers","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"address","name":"_recipient","type":"address"}],"name":"withdrawSurplusCapital","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"yieldVaultAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}]`)
    };

    // --- Main Functions ---
    async function connectWallet() {
        if (!window.ethereum) return showModal("Error", "Please install MetaMask to use this dApp.");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            currentAddress = await signer.getAddress();
            
            usdcContract = new ethers.Contract(addresses.nativeUsdc, abis.usdc, signer);
            investorVaultContract = new ethers.Contract(addresses.investorVault, abis.investorVault, signer);
            yieldVaultContract = new ethers.Contract(addresses.yieldVault, abis.yieldVault, signer);
            kernelContract = new ethers.Contract(addresses.kernel, abis.kernel, signer);

            document.getElementById('walletStatus').innerHTML = `<p class="text-green-400 font-semibold">Connected</p>`;
            document.getElementById('walletAddress').textContent = currentAddress;
            document.getElementById('userSection').classList.remove('hidden');

            isSolver = await kernelContract.whitelistedSolvers(currentAddress); // Assign to global isSolver
            if (isSolver) {
                document.getElementById('solverSection').classList.remove('hidden');
                fetchSolverData();
            }

            const kernelOwner = await kernelContract.owner();
            if (currentAddress.toLowerCase() === kernelOwner.toLowerCase()) {
                document.getElementById('daoTools').classList.remove('hidden');
                fetchAllDaoData();
            }

            fetchUserData();
            await setupEventListeners();
        } catch (error) {
            console.error("Failed to connect wallet:", error);
            showModal("Error", `Failed to connect wallet: ${error.message || "Unknown error."}`);
        }
    }

    // --- Data Fetching (UPDATED) ---
    async function fetchUserData() {
        try {
            const nativeBalance = await usdcContract.balanceOf(currentAddress);
            document.getElementById('nativeUsdcBalance').textContent = `${parseFloat(ethers.formatUnits(nativeBalance, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 })} USDC`;

            const info = await investorVaultContract.getInvestorInfo(currentAddress);
            shareAmount = info.share;
            const claimable = ethers.formatUnits(info.claimable, 6);
            document.getElementById('userShares').textContent = parseFloat(ethers.formatUnits(shareAmount, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('claimableYield').textContent = `$${parseFloat(claimable).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 })}`;
        } catch (err) {
            console.error("Error fetching user data:", err);
            // Don't show modal for passive data fetch errors
        }
    }

    async function fetchSolverData() {
        try {
            // This function assumes the contract reverts if there is no loan.
            // The catch block handles this by showing a "no loan" message.
            const loanDetails = await kernelContract.getLoanDetails(currentAddress);
            const principal = loanDetails.principal;
            const interest = loanDetails.interest;

            if (principal === 0n && interest === 0n) {
                 throw new Error("No outstanding loan found.");
            }

            const totalDue = principal + interest;

            document.getElementById('solverLoanPrincipal').textContent = `${parseFloat(ethers.formatUnits(principal, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;
            document.getElementById('solverLoanInterest').textContent = `${parseFloat(ethers.formatUnits(interest, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;
            document.getElementById('solverTotalDue').textContent = `${parseFloat(ethers.formatUnits(totalDue, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;

        } catch (err) {
             console.error("Error fetching solver data:", err);
             const solverInfoDiv = document.getElementById('solverLoanInfo');
             solverInfoDiv.innerHTML = '<p class="text-gray-400">No outstanding loan found or could not fetch data.</p>';
        }
    }

    async function fetchAllDaoData() {
        try {
            const [kernelBal, yieldVaultBal, investorVaultBal, investorVaultTotals, totalCapDeployed, totalFeesProcessed, perfFee] = await Promise.all([
                kernelContract.getKernelBalance(),
                yieldVaultContract.getVaultBalance(),
                usdcContract.balanceOf(addresses.investorVault), 
                investorVaultContract.getVaultTotals(),
                kernelContract.totalCapitalDeployed(),
                kernelContract.totalFeesProcessedViaKernel(),
                kernelContract.performanceFeeBps()
            ]);
            document.getElementById('kernelBalance').textContent = `$${parseFloat(ethers.formatUnits(kernelBal, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('yieldVaultBalance').textContent = `$${parseFloat(ethers.formatUnits(yieldVaultBal, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('investorVaultBalance').textContent = `$${parseFloat(ethers.formatUnits(investorVaultBal, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('investorVaultTotalDeposits').textContent = `$${parseFloat(ethers.formatUnits(investorVaultTotals.totalUSDC, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalCapitalDeployed').textContent = `$${parseFloat(ethers.formatUnits(totalCapDeployed, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalFeesProcessed').textContent = `$${parseFloat(ethers.formatUnits(totalFeesProcessed, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('performanceFee').textContent = `${(Number(perfFee) / 100).toFixed(2)}%`;

        } catch (err) {
            console.error('Error fetching DAO data:', err);
            showModal("DAO Data Error", "Could not fetch all system stats. The contract ABIs might be out of sync. Check the console for details.");
        }
    }

    // --- User Actions ---
    async function approveDeposit() {
        await handleApproval(document.getElementById('depositAmount').value, addresses.investorVault);
    }
    async function deposit() {
        await handleTransaction(investorVaultContract, 'deposit', [ethers.parseUnits(document.getElementById('depositAmount').value || '0', 6)], "Deposit");
    }
    async function claimYield() {
        await handleTransaction(investorVaultContract, 'claimYield', [], "Claim Yield");
    }
    async function compoundYield() {
        await handleTransaction(investorVaultContract, 'compoundYield', [], "Compound Yield");
    }
    async function withdraw() {
        if (shareAmount === 0n) return showModal("Withdraw Error", "You have no shares to withdraw.");
        await handleTransaction(investorVaultContract, 'withdraw', [shareAmount], "Withdraw All");
    }

    // --- DAO & Solver Actions (UPDATED) ---
    async function approveFundKernel() {
        await handleApproval(document.getElementById('kernelAmount').value, addresses.kernel);
    }
    async function fundKernel() {
        await handleTransaction(kernelContract, 'depositCapital', [ethers.parseUnits(document.getElementById('kernelAmount').value || '0', 6)], "Fund Kernel from Wallet");
    }
    async function setPerformanceFee() {
        const feeBps = document.getElementById('performanceFeeBps').value;
        if (!feeBps || isNaN(feeBps) || feeBps < 0 || feeBps > 10000) {
            return showModal("Input Error", "Please enter a valid fee in basis points (0-10000).");
        }
        await handleTransaction(kernelContract, 'setPerformanceFee', [BigInt(feeBps)], "Set Performance Fee");
    }
    async function approveRepayLoan() {
        await handleApproval(document.getElementById('repayAmount').value, addresses.kernel);
    }
    async function repayLoan() {
        await handleTransaction(kernelContract, 'recordLoanPrincipalRepayment', [ethers.parseUnits(document.getElementById('repayAmount').value || '0', 6)], "Repay Loan");
    }
    async function approveProcessFees() {
        await handleApproval(document.getElementById('feeAmount').value, addresses.kernel);
    }
    async function processFees() {
        await handleTransaction(kernelContract, 'processSolverFees', [ethers.parseUnits(document.getElementById('feeAmount').value || '0', 6)], "Process Fees");
    }
    async function sweepFees() {
        const amount = document.getElementById('sweepAmount').value;
        if (amount && Number(amount) > 0) {
            await handleTransaction(yieldVaultContract, 'sweepToTreasury', [ethers.parseUnits(amount, 6)], "Sweep Fees");
        } else {
            await handleTransaction(yieldVaultContract, 'sweepFullBalanceToTreasury', [], "Sweep Full Balance");
        }
    }
    async function addSolver() {
        const solverAddress = document.getElementById('solverAddress').value;
        if (!ethers.isAddress(solverAddress)) return showModal("Input Error", "Please enter a valid Ethereum address.");
        await handleTransaction(kernelContract, 'setSolverAddress', [solverAddress, true], "Add Solver");
    }
    async function removeSolver() {
        const solverAddress = document.getElementById('solverAddress').value;
        if (!ethers.isAddress(solverAddress)) return showModal("Input Error", "Please enter a valid Ethereum address.");
        await handleTransaction(kernelContract, 'setSolverAddress', [solverAddress, false], "Remove Solver");
    }
    async function checkSolverStatus() {
        const solverAddress = document.getElementById('solverAddress').value;
        if (!ethers.isAddress(solverAddress)) return showModal("Input Error", "Please enter a valid Ethereum address.");
        
        showModal("Checking Status...", `Fetching details for ${solverAddress}...`);

        try {
            const isWhitelisted = await kernelContract.whitelistedSolvers(solverAddress);
            let message = `<div class="text-left">Address <span class="font-mono text-xs">${solverAddress}</span> is ${isWhitelisted ? '<span class="text-green-400 font-bold">whitelisted</span>' : '<span class="text-red-400 font-bold">NOT whitelisted</span>'}.</div>`;
            
            if (isWhitelisted) {
                try {
                    const loanDetails = await kernelContract.getLoanDetails(solverAddress);
                    const principal = loanDetails.principal;
                    const interest = loanDetails.interest;

                    if (principal > 0n) {
                         const totalDue = principal + interest;
                         const principalFormatted = parseFloat(ethers.formatUnits(principal, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                         const interestFormatted = parseFloat(ethers.formatUnits(interest, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                         const totalDueFormatted = parseFloat(ethers.formatUnits(totalDue, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                         message += `
                            <div class="mt-4 text-left p-3 bg-gray-700 rounded-md">
                                <h4 class="font-semibold text-white mb-1">Outstanding Loan:</h4>
                                <p>Principal: <span class="font-bold text-cyan-400">${principalFormatted} USDC</span></p>
                                <p>Interest: <span class="font-bold text-red-400">${interestFormatted} USDC</span></p>
                                <p>Total Due: <span class="font-bold text-yellow-400">${totalDueFormatted} USDC</span></p>
                            </div>
                        `;
                    } else {
                        message += '<div class="text-gray-400 mt-2 text-left">This solver has no active loan.</div>';
                    }

                } catch (loanError) {
                     console.error("Could not fetch loan details for solver:", loanError);
                     message += '<div class="text-gray-400 mt-2 text-left">This solver has no active loan.</div>';
                }
            }
            
            showModal("Solver Status", message);

        } catch (e) {
            console.error("Failed to check solver status:", e);
            showModal("Error", "Could not check solver status.");
        }
    }
    async function disburseLoan() {
        const solverAddress = document.getElementById('disburseSolverAddress').value;
        const amount = document.getElementById('disburseAmount').value;
        if (!ethers.isAddress(solverAddress)) return showModal("Input Error", "Please enter a valid solver address.");
        if (!amount || isNaN(amount) || Number(amount) <= 0) return showModal("Input Error", "Please enter a valid amount to disburse.");
        const amountInUnits = ethers.parseUnits(amount, 6);
        await handleTransaction(kernelContract, 'disburseLoan', [solverAddress, amountInUnits], "Disburse Loan");
    }
    async function daoBatchClaim() {
        const addresses = document.getElementById('batchAddresses').value.split(/[\s,]+/).filter(addr => ethers.isAddress(addr));
        if (addresses.length === 0) return showModal("Input Error", "Please provide at least one valid address.");
        await handleTransaction(investorVaultContract, 'batchClaimYield', [addresses], "Batch Claim");
    }
    async function daoBatchWithdraw() {
        const addresses = document.getElementById('batchAddresses').value.split(/[\s,]+/).filter(addr => ethers.isAddress(addr));
        if (addresses.length === 0) return showModal("Input Error", "Please provide at least one valid address.");
        await handleTransaction(investorVaultContract, 'batchWithdraw', [addresses], "Batch Withdraw");
    }
    
    // --- Event Handling & Logging ---
    async function setupEventListeners() {
        const log = document.getElementById('eventLog');
        if (log.dataset.listening) {
            try {
                investorVaultContract.removeAllListeners();
                yieldVaultContract.removeAllListeners();
                kernelContract.removeAllListeners();
            } catch (e) { console.warn("Could not remove all listeners", e); }
        }
        log.dataset.listening = 'true';
        log.innerHTML = '<li>Listening for real-time events...</li>';

        try {
            investorVaultContract.on('*', (event) => addLogEntry(event, 'InvestorVault'));
            yieldVaultContract.on('*', (event) => addLogEntry(event, 'YieldVault'));
            kernelContract.on('*', (event) => addLogEntry(event, 'Kernel'));
        } catch (e) { console.error("Fatal error setting up event listeners:", e); }
    }

    function addLogEntry(event, contractName) {
        if (!event || !event.fragment) return;
        const li = document.createElement('li');
        li.className = 'border-b border-gray-700 pb-1 mb-1 text-left';
        
        let argsString = "No arguments";
        if (event.args && Object.keys(event.args).length > 0) {
            argsString = Object.keys(event.args)
                .filter(key => isNaN(parseInt(key))) 
                .map(key => {
                    let value = event.args[key];
                    let displayValue = value.toString();
                    if (typeof value === 'bigint') {
                         try {
                             // Attempt to format as USDC if it's likely a token amount
                             if (value > 10000n) displayValue = `${parseFloat(ethers.formatUnits(value, 6)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                         } catch {}
                    }
                    if (typeof value === 'string' && value.startsWith('0x')) {
                        displayValue = `<span class="font-mono text-xs">${value.substring(0,6)}...${value.substring(value.length-4)}</span>`;
                    }
                     return `${key}: <span class="text-green-300">${displayValue}</span>`;
                }).join(', ');
        }

        li.innerHTML = `<div><span class="font-bold text-gray-400">[${contractName}]</span> <span class="font-bold text-orange-400">${event.fragment.name}</span></div><div class="text-xs text-gray-300 pl-4">${argsString}</div>`;
        document.getElementById('eventLog').prepend(li);
    }

    // --- Generic Handlers ---
    async function handleApproval(amount, spender) {
        if (!amount || isNaN(amount) || Number(amount) <= 0) return showModal("Input Error", "Please enter a valid amount to approve.");
        showModal("Processing", "Requesting approval from your wallet...");
        try {
            const tx = await usdcContract.approve(spender, ethers.parseUnits(amount, 6));
            await tx.wait();
            showModal("Success", `Successfully approved ${amount} USDC.`);
        } catch (error) {
            console.error("Approval failed:", error);
            showModal("Error", `Approval failed: ${error?.reason || error.message}`);
        }
    }

    async function handleTransaction(contractInstance, method, args = [], name) {
        showModal("Processing", `Sending ${name} transaction... Please confirm in your wallet.`);
        try {
            const tx = await contractInstance[method](...args);
            await tx.wait();
            showModal("Success", `${name} transaction was successful!`);
            
            fetchUserData();
            if (isSolver) {
                fetchSolverData();
            }
            if (!document.getElementById('daoTools').classList.contains('hidden')) {
                 fetchAllDaoData();
            }
        } catch (error) {
            console.error(`${name} failed:`, error);
            showModal("Error", `${name} failed: ${error?.reason || error.message}`);
        }
    }
    
    // --- UI Utility ---
    function showModal(title, message) {
        const existingModal = document.getElementById('alertModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'alertModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center border-2 border-orange-500">
                <h3 class="text-xl font-bold text-orange-400 mb-4">${title}</h3>
                <div class="text-gray-200 mb-6 break-words">${message}</div>
                <button onclick="document.getElementById('alertModal').remove()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // --- Expose functions to global scope for HTML onclick handlers ---
    window.connectWallet = connectWallet;
    window.approveDeposit = approveDeposit;
    window.deposit = deposit;
    window.claimYield = claimYield;
    window.compoundYield = compoundYield;
    window.withdraw = withdraw;
    window.approveFundKernel = approveFundKernel;
    window.fundKernel = fundKernel;
    window.approveRepayLoan = approveRepayLoan;
    window.repayLoan = repayLoan;
    window.approveProcessFees = approveProcessFees;
    window.processFees = processFees;
    window.sweepFees = sweepFees;
    window.setPerformanceFee = setPerformanceFee;
    window.addSolver = addSolver;
    window.removeSolver = removeSolver;
    window.checkSolverStatus = checkSolverStatus;
    window.disburseLoan = disburseLoan;
    window.daoBatchClaim = daoBatchClaim;
    window.daoBatchWithdraw = daoBatchWithdraw;

</script>

</body>
</html>
